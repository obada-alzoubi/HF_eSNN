<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimating uncertainty in polygenic scores using LDpred2 • bigsnpr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Estimating uncertainty in polygenic scores using LDpred2">
<meta property="og:description" content="bigsnpr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bigsnpr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.7.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Manual</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demo.html">Quick demo</a>
    </li>
    <li>
      <a href="../articles/exo.html">Exercise</a>
    </li>
    <li>
      <a href="../articles/pruning-vs-clumping.html">Why clumping should be preferred over pruning</a>
    </li>
    <li>
      <a href="../articles/how-to-PCA.html">How to capture Population Structure with PCA (LD problem explained)</a>
    </li>
    <li>
      <a href="../articles/bedpca.html">How to capture Population Structure with PCA (directly on PLINK bed files)</a>
    </li>
    <li>
      <a href="../articles/SCT.html">Computing polygenic scores using Stacked Clumping and Thresholding (SCT)</a>
    </li>
    <li>
      <a href="../articles/LDpred2.html">Computing polygenic scores using LDpred2</a>
    </li>
    <li>
      <a href="../articles/prs_uncertainty.html">Estimating uncertainty in polygenic scores using LDpred2</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://privefl.github.io/about.html">
    <span class="fas fa-user"></span>
     
    About
  </a>
</li>
<li>
  <a href="https://github.com/privefl/bigsnpr">
    <span class="fas fa-github fa"></span>
     
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fas fa-newspaper-o fa"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="prs_uncertainty_files/header-attrs/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Estimating uncertainty in polygenic scores using LDpred2</h1>
                        <h4 class="author">Yi Ding and colleagues</h4>
            
            <h4 class="date">March 26, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/privefl/bigsnpr/blob/master/vignettes/prs_uncertainty.Rmd"><code>vignettes/prs_uncertainty.Rmd</code></a></small>
      <div class="hidden name"><code>prs_uncertainty.Rmd</code></div>

    </div>

    
    
<hr>
<p>Here we show how to estimate the full posterior distribution of genetic value using LDpred2 as described in <a href="https://doi.org/10.1101/2020.11.30.403188">Large uncertainty in individual PRS estimation impacts PRS-based risk stratification</a>.</p>
<p>This tutorial assumes that you have already tuned the hyperparameters using grid search. Please refer to <a href="https://privefl.github.io/bigsnpr/articles/LDpred2.html">Computing polygenic scores using LDpred2</a> for tutorials on data preprocessing and LDpred2-grid.</p>
<div id="approximating-the-posterior-distribution-of-genetic-value" class="section level2">
<h2 class="hasAnchor">
<a href="#approximating-the-posterior-distribution-of-genetic-value" class="anchor"></a>Approximating the posterior distribution of genetic value</h2>
<p>Given the set of tuned hyperparameters (see above), we want to approximate the full posterior distribution of an individual’s genetic value, <span class="math inline">\(\small{GV_i = \mathrm{\bf{x}}_i^T \boldsymbol\beta}\)</span>. From the posterior, one can obtain the <strong>posterior mean</strong>, <span class="math inline">\(\small{\widehat{PRS}_i \equiv \mathbb{E}(GV_i|\mathrm{Data})}\)</span>, and various metrics of uncertainty such as the <strong>posterior variance</strong>, <span class="math inline">\(\small{var(GV_i|\mathrm{Data})}\)</span>, where <span class="math inline">\(\small{GV_i}\)</span> is the genetic value of individual <span class="math inline">\(i\)</span> and <span class="math inline">\(\mathrm{\small{Data}}\)</span> refers to a given GWAS, and <strong><span class="math inline">\(\rho\)</span>-credible interval</strong>, the interval within which the individual’s genetic value falls with probability <span class="math inline">\(\rho\)</span>.</p>
<p>An individual’s genetic value is their genotype vector multipled by the causal effect vector. We therefore need to obtain MCMC samples from the posterior of the causal effects. This is done by supplying the tuned hyperparameters (<code>best_param</code> in the example below) to <code>snp_ldpred2_grid</code> and setting <code>return_sampling_betas = TRUE</code>. In the example below, we return 500 MCMC samples from the posterior of the causal effects with the option <code>num_iter = 500</code>.</p>
<p>Note that, when using <code>return_sampling_betas = TRUE</code>, you must supply one set of parameters only, i.e. <code>best_param</code> must be a data frame with exactly 1 row (otherwise it will raise an error).</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="va">best_param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">0.0018</span>, h2 <span class="op">=</span> <span class="fl">0.1146</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="va">posterior_beta_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snp_ldpred2_inf.html">snp_ldpred2_grid</a></span><span class="op">(</span>
  <span class="va">corr</span>, <span class="va">df_beta</span>, <span class="va">best_param</span>,
  return_sampling_betas <span class="op">=</span> <span class="cn">TRUE</span>, num_iter <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">posterior_beta_samples</span><span class="op">)</span></pre></div>
<pre><code>## [1] 52546   500</code></pre>
<p>Posterior samples of the individual’s genetic value are then obtained by multiplying their genotype with the posterior samples of <span class="math inline">\(\boldsymbol{\beta}\)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">posterior_gv_samples</span> <span class="op">&lt;-</span> <span class="fu">big_prodMat</span><span class="op">(</span><span class="va">G</span>, <span class="va">posterior_beta_samples</span>, ind.col <span class="op">=</span> <span class="va">ind.chr2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">posterior_gv_samples</span><span class="op">)</span></pre></div>
<pre><code>## [1] 559 500</code></pre>
<p>The autocorrelation is generally weak, otherwise, you can perform some thinning.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/acf.html">acf</a></span><span class="op">(</span><span class="va">posterior_gv_samples</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, lag.max <span class="op">=</span> <span class="fl">10</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">acf</span></pre></div>
<p><img src="prs_uncertainty_files/figure-html/unnamed-chunk-4-1.png" width="700" style="display: block; margin: auto;"></p>
<pre><code>## , , 1
## 
##                [,1]
##  [1,]  1.0000000000
##  [2,] -0.0786463139
##  [3,]  0.0218726514
##  [4,]  0.0271931106
##  [5,] -0.0287941817
##  [6,]  0.0111070845
##  [7,] -0.0149171804
##  [8,]  0.0165611609
##  [9,]  0.0758901569
## [10,]  0.0171239973
## [11,]  0.0002881344</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">posterior_gv_samples</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/acf.html">acf</a></span><span class="op">(</span><span class="va">x</span>, lag.max <span class="op">=</span> <span class="fl">10</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">acf</span>
<span class="op">}</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>##  [1]  1.000000000 -0.007897343  0.026445937 -0.012760849 -0.008629879
##  [6] -0.001409748 -0.013761490  0.005290774 -0.010247640 -0.019465620
## [11] -0.055678966</code></pre>
</div>
<div id="estimating-the-posterior-mean-and-posterior-variance" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-the-posterior-mean-and-posterior-variance" class="anchor"></a>Estimating the posterior mean and posterior variance</h2>
<p>From the posterior samples of genetic value (see above), we can compute summary statistics such as the posterior mean and posterior variance. The posterior mean can be interpreted as the individual’s polygenic (risk) score, i.e. <span class="math inline">\(\small{\widehat{PRS}_i \equiv \mathbb{E}(GV_i|\mathrm{Data})}\)</span>. The posterior variance, <span class="math inline">\(\small{var(GV_i|\mathrm{Data})}\)</span>, is one metric of uncertainty; credible intervals are discussed below.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="va">posterior_gv_samples</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>
<span class="va">posterior_gv_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="va">posterior_gv_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></pre></div>
</div>
<div id="constructing-credible-intervals-of-genetic-value" class="section level2">
<h2 class="hasAnchor">
<a href="#constructing-credible-intervals-of-genetic-value" class="anchor"></a>Constructing credible intervals of genetic value</h2>
<p>Another way to quantify uncertainty in an individual’s polygenic score is by constructing a <span class="math inline">\(\rho\)</span>-credible interval of the individual’s genetic value, i.e. the range of values that contains the individual’s true genetic value with probability <span class="math inline">\(\rho\)</span>.</p>
<p>The example below demonstrates how one can obtain a 95% credible interval of the individual’s genetic value.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">0.95</span>
<span class="va">bound</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">rho</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>
<span class="va">samples</span> <span class="op">&lt;-</span> <span class="va">posterior_gv_samples</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>
<span class="va">mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span>
<span class="va">lower_ci</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">bound</span><span class="op">)</span>
<span class="va">upper_ci</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">samples</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">bound</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">samples</span>, main <span class="op">=</span> <span class="st">"Posterior distribution of genetic value"</span>, xlab <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">lower_ci</span>, <span class="va">mean</span>, <span class="va">upper_ci</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Credible Interval"</span>, <span class="st">"PRS"</span><span class="op">)</span>,
       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"red"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></pre></div>
<p><img src="prs_uncertainty_files/figure-html/unnamed-chunk-6-1.png" width="700" style="display: block; margin: auto;"></p>
<p>To get for all individuals:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="va">means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">posterior_gv_samples</span><span class="op">)</span>
<span class="va">limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">posterior_gv_samples</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bound</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">bound</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Florian Privé.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
